<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CL é›¢è·é›†é»è¶£</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #ff4d4f;
            --primary-bg: #fff1f0;
            --text-dark: #2c3e50;
            --bg-dots: #f0f2f5;
        }

        body {
            background-color: var(--bg-dots);
            background-image: radial-gradient(#d9d9d9 1.5px, transparent 1.5px);
            background-size: 15px 15px;
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: var(--text-dark);
            padding-bottom: 50px; /* çµ¦é™¤éŒ¯å€ç•™ç©ºé–“ */
        }

        .app-container {
            width: 100%;
            max-width: 450px; /* ç¨å¾®å¯¬ä¸€é»æ”¾30æ ¼ */
            background: rgba(255,255,255,0.96);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid var(--primary-red);
            z-index: 2;
        }

        h1 { margin: 0; font-family: 'Fredoka', sans-serif; color: var(--primary-red); }

        .tabs { display: flex; padding: 10px; gap: 10px; background: #fff; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 8px; background: #f5f5f5; cursor: pointer; font-weight: bold; color: #888; transition: 0.2s; }
        .tab.active { background: var(--primary-red); color: white; }

        .user-info { padding: 10px 20px; text-align: right; font-size: 0.85rem; color: #666; background: #fafafa; display: flex; justify-content: space-between; align-items: center;}
        
        .card-view { padding: 15px; flex: 1; display: flex; flex-direction: column; }

        .loyalty-card {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            border: 2px dashed #ffccc7;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .points-header { text-align: center; margin-bottom: 20px; }
        .points-number { font-size: 2.5rem; font-family: 'Fredoka', sans-serif; color: var(--primary-red); font-weight: bold; }

        /* 30æ ¼ä½ˆå±€ï¼šæ”¹æˆ 5æ¬„ */
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5æ¬„ */
            gap: 10px;
        }

        .stamp-slot {
            aspect-ratio: 1;
            border-radius: 50%;
            background: #fff;
            border: 2px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #ccc;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }

        /* æ•¸å­—æ¨™ç¤º */
        .stamp-slot span { font-size: 0.7rem; font-family: 'Fredoka'; opacity: 0.5; }

        /* ä¸‹ä¸€å€‹å¯é»æ“Š */
        .stamp-slot.next-up {
            border-color: var(--primary-red);
            background: var(--primary-bg);
            animation: pulse 1.5s infinite;
            cursor: pointer;
        }
        .stamp-slot.next-up span { display: none; }
        .stamp-slot.next-up::after { content: "â•"; font-size: 1.2rem; }

        /* å·²è“‹ç«  */
        .stamp-slot.stamped {
            border: 2px solid var(--primary-red);
            background: #fff5f5;
            color: transparent;
        }
        .stamp-slot.stamped span { display: none; }
        .stamp-slot.stamped::before {
            content: "é›¢"; /* é€™è£¡å¯ä»¥æ”¹æˆ Emoji å¦‚ ğŸ’¢ */
            color: var(--primary-red);
            font-weight: bold;
            font-size: 1.2rem;
            position: absolute;
            transform: rotate(-15deg);
        }

        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.8; } }

        /* åˆ—è¡¨ */
        .list-view { display: none; padding: 20px; }
        .record-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary-red); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; width: 85%; max-width: 320px; border-radius: 15px; text-align: center; }
        textarea { width: 100%; height: 80px; margin: 15px 0; padding: 10px; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; }
        
        .btn { background: var(--primary-red); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        
        /* é™¤éŒ¯å€ */
        #debugArea {
            padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 0.7rem;
            word-break: break-all; margin-top: 20px; border-radius: 5px; display: none;
        }

        #loginScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; box-sizing: border-box; }
        input[type="text"] { width: 100%; padding: 15px; margin: 20px 0; border: 2px solid #ddd; border-radius: 12px; font-size: 1.1rem; text-align: center; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="loginScreen">
        <h1>CL é›¢è·é›†é»è¶£</h1>
        <p style="color:#888">30 æ¬¡çš„å‹‡æ°£ï¼Œæ›ä¸€æ¬¡è‡ªç”±</p>
        <input type="text" id="nicknameInput" placeholder="è¼¸å…¥æš±ç¨±">
        <button class="btn" onclick="login()">é–‹å§‹</button>
        <div style="margin-top:20px; font-size:0.8rem; color:#ccc;" onclick="toggleDebug()">é€£é»é€™è£¡é–‹å•Ÿé™¤éŒ¯æ¨¡å¼</div>
    </div>

    <header>
        <h1>CL é›¢è·é›†é»è¶£ ğŸš€</h1>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('card', this)">é›†é»å¡</div>
        <div class="tab" onclick="switchTab('list', this)">å¿ƒè²ç‰†</div>
    </div>

    <div class="user-info">
        <span id="displayNickname">...</span>
        <a style="color:var(--primary-red); cursor:pointer;" onclick="logout()">ç™»å‡º</a>
    </div>

    <div id="cardView" class="card-view">
        <div class="loyalty-card">
            <div class="points-header">
                <span class="points-number" id="stampCount">0</span>
                <span style="color:#999; font-size:1.2rem;">/ 30</span>
            </div>
            <div class="stamp-grid" id="grid"></div>
        </div>
        
        <div id="debugArea">Waiting for data...</div>
    </div>

    <div id="listView" class="list-view">
        <div id="recordList">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<div class="modal" id="reasonModal">
    <div class="modal-content">
        <h3>ğŸ˜¤ è¨˜éŒ„åŸå› </h3>
        <textarea id="reasonText" placeholder="é€™æ¬¡åˆæ˜¯å› ç‚ºä»€éº¼ï¼Ÿ"></textarea>
        <button id="confirmBtn" class="btn" onclick="submitReason()">è“‹ç« ï¼</button>
        <button style="margin-top:10px; background:none; border:none; color:#999;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // ==========================================
    // è«‹å¡«å…¥ä½ ã€Œé‡æ–°éƒ¨ç½²ã€å¾Œçš„ç¶²å€
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQsuVw2L49zf5pIJKoPCarGP5kcax3T79PvCsTTB3xG0LxwEcfqZQClpwXvS2-gTWYPw/exec"; 

    let currentUser = "";
    let localStampCount = 0;
    let userIP = "Unknown";
    const grid = document.getElementById('grid');
    const modal = document.getElementById('reasonModal');
    const debugArea = document.getElementById('debugArea');

    function log(msg) {
        console.log(msg);
        debugArea.innerHTML += "<div>> " + msg + "</div>";
    }

    function toggleDebug() {
        debugArea.style.display = debugArea.style.display === 'block' ? 'none' : 'block';
    }

    function initGrid() {
        grid.innerHTML = '';
        // ç”¢ç”Ÿ 30 æ ¼
        for(let i=0; i<30; i++) {
            let slot = document.createElement('div');
            slot.className = 'stamp-slot';
            slot.innerHTML = `<span>${i+1}</span>`; // é¡¯ç¤ºæ•¸å­—
            slot.dataset.idx = i;
            grid.appendChild(slot);
        }
        // åˆå§‹åŒ–æ™‚ï¼Œå¼·åˆ¶è®“ç¬¬ä¸€æ ¼è®Šæˆå¯é»æ“Šç‹€æ…‹ï¼Œé˜²æ­¢ç„¡æ³•æ“ä½œ
        updateGrid(0);
    }

    function init() {
        initGrid();
        const savedName = localStorage.getItem('cl_nickname');
        if(savedName) {
            currentUser = savedName;
            document.getElementById('nicknameInput').value = savedName;
            login();
        }
        
        // æŠ“ IP
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => userIP = data.ip)
            .catch(err => log("IP Error: " + err));
    }

    function login() {
        const input = document.getElementById('nicknameInput').value.trim();
        if(!input) return alert("è«‹è¼¸å…¥æš±ç¨±");
        
        currentUser = input;
        localStorage.setItem('cl_nickname', currentUser);
        document.getElementById('displayNickname').innerText = currentUser;
        document.getElementById('loginScreen').style.display = 'none';
        
        log("Logging in as: " + currentUser);
        fetchData();
    }

    function logout() {
        localStorage.removeItem('cl_nickname');
        location.reload();
    }

    function switchTab(view, tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('cardView').style.display = view === 'card' ? 'flex' : 'none';
        document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
        if(view === 'list') fetchData();
    }

    function openModal() {
        modal.style.display = 'flex';
        setTimeout(() => document.getElementById('reasonText').focus(), 100);
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    function submitReason() {
        const reason = document.getElementById('reasonText').value;
        if(!reason) return alert("è«‹å¯«ä¸‹åŸå› ");

        const btn = document.getElementById('confirmBtn');
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";

        // æ¨‚è§€æ›´æ–°
        localStampCount++;
        updateGrid(localStampCount);

        const payload = { nickname: currentUser, reason: reason, ip: userIP };
        log("Sending: " + JSON.stringify(payload));

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            mode: 'no-cors'
        }).then(() => {
            log("Submit Success");
            closeModal();
            document.getElementById('reasonText').value = '';
            btn.disabled = false;
            btn.innerText = "è“‹ç« ï¼";
            setTimeout(fetchData, 1500);
        }).catch(err => {
            log("Submit Error: " + err);
            alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹é™¤éŒ¯å€");
            btn.disabled = false;
        });
    }

    function fetchData() {
        log("Fetching data...");
        const url = SCRIPT_URL + "?t=" + new Date().getTime();
        
        fetch(url)
        .then(res => res.json())
        .then(data => {
            log("Data received: " + data.length + " records");
            
            // æ›´æ–°åˆ—è¡¨
            const listDiv = document.getElementById('recordList');
            listDiv.innerHTML = '';
            data.forEach(item => {
                let div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `<div><b>${item.nickname}</b> <small>${new Date(item.time).toLocaleDateString()}</small></div><div style="color:#666">${item.reason}</div>`;
                listDiv.appendChild(div);
            });

            // æ›´æ–°å€‹äººé›†é»
            const myRecords = data.filter(d => d.nickname.trim() === currentUser.trim());
            const serverCount = myRecords.length;
            log("My Count: " + serverCount);

            if(serverCount > localStampCount) localStampCount = serverCount;
            updateGrid(localStampCount);
        })
        .catch(err => {
            log("Fetch Error: " + err);
            // é€™è£¡é¡¯ç¤ºç´…å­—æé†’
            debugArea.style.display = 'block';
            debugArea.innerHTML += "<div style='color:red'>âš ï¸ è®€å–å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œã€‚è«‹ç¢ºèª Apps Script éƒ¨ç½²ç‚ºã€Œä»»ä½•äººã€ã€‚</div>";
        });
    }

    function updateGrid(count) {
        document.getElementById('stampCount').innerText = count;
        const slots = document.querySelectorAll('.stamp-slot');
        
        slots.forEach((slot, index) => {
            slot.className = 'stamp-slot'; // é‡ç½®
            slot.onclick = null;

            if(index < count) {
                slot.classList.add('stamped');
            } else if (index === count) {
                slot.classList.add('next-up');
                slot.onclick = openModal; // é—œéµï¼šç¢ºä¿é€™æ ¼å¯ä»¥é»
            }
        });
    }

    init();
    
    window.onclick = function(event) {
        if (event.target == modal) closeModal();
    }
</script>

</body>
</html>
