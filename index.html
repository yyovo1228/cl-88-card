<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CL é›¢è·é›†é»è¶£</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #d93025; /* ç¨å¾®äº®ä¸€é»çš„ç´…ï¼Œæ¯”è¼ƒæœ‰æ´»åŠ› */
            --primary-light: #ffeceb;
            --text-main: #4a4a4a;
            --text-sub: #888;
            --card-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        body {
            /* è¼•é¬†çš„åœ“é»èƒŒæ™¯ */
            background-color: #f8f9fa;
            background-image: radial-gradient(#e0e0e0 2px, transparent 2px);
            background-size: 20px 20px;
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: var(--text-main);
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: relative;
            min-height: 100vh;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
        }

        header {
            background: white;
            padding: 25px 20px;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        h1 { 
            margin: 0; 
            font-family: 'Fredoka', sans-serif;
            font-size: 1.6rem; 
            color: var(--primary-red); 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* åˆ‡æ›é ç±¤ - åƒè—¥ä¸¸ä¸€æ¨£çš„é€ å‹ */
        .tabs {
            display: flex;
            padding: 15px 20px;
            gap: 10px;
            justify-content: center;
        }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: var(--text-sub);
            cursor: pointer;
            border-radius: 50px;
            background: #eee;
            transition: 0.3s;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .tab.active {
            background: var(--primary-red);
            color: white;
            box-shadow: 0 4px 10px rgba(217, 48, 37, 0.3);
            transform: translateY(-2px);
        }

        .user-info {
            padding: 5px 25px;
            font-size: 0.85rem;
            text-align: right;
            color: var(--text-sub);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }
        .logout-link {
            color: var(--primary-red);
            text-decoration: none;
            cursor: pointer;
            border: 1px solid var(--primary-red);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* å¡ç‰‡å€åŸŸ */
        .card-view {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .loyalty-card {
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            border: 2px dashed #ffccc7; /* å¯æ„›çš„è™›ç·šé‚Šæ¡† */
            box-shadow: var(--card-shadow);
            position: relative;
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: 0.3s;
        }
        
        .loyalty-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #f0f0f0;
        }
        .points-display {
            font-family: 'Fredoka', sans-serif;
            font-size: 2.2rem;
            color: var(--primary-red);
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .stamp-slot {
            aspect-ratio: 1;
            background: #fafafa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
            border: 2px solid transparent;
            font-size: 1.5rem; /* Emoji å¤§å° */
            color: #ddd;
        }
        
        /* æœªè“‹ç« çš„æ ¼å­æ¨£å¼ */
        .stamp-slot:not(.stamped) {
            border: 2px dashed #e0e0e0;
        }
        .stamp-slot:not(.stamped)::before {
            content: "âšª";
            opacity: 0.3;
            filter: grayscale(1);
        }

        /* ä¸‹ä¸€å€‹å¯ä»¥è“‹çš„æ ¼å­ */
        .stamp-slot.next-up {
            border-color: var(--primary-red);
            background: var(--primary-light);
            animation: pulse 2s infinite;
        }
        .stamp-slot.next-up::before {
            content: "ğŸ‘‡";
            opacity: 1;
            filter: none;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(217, 48, 37, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(217, 48, 37, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 48, 37, 0); }
        }

        /* å·²è“‹ç« æ¨£å¼ */
        .stamp-slot.stamped {
            background: #fff0f0;
            border: 2px solid var(--primary-red);
        }
        .stamp-slot.stamped::after {
            content: "ğŸ‰"; /* æ”¹ç”¨ Emoji ç«  */
            position: absolute;
            font-size: 1.6rem;
            animation: stampIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        @keyframes stampIn {
            0% { transform: scale(3) rotate(10deg); opacity: 0; }
            80% { transform: scale(0.9) rotate(-10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-view { display: none; padding: 20px; width: 100%; box-sizing: border-box;}
        
        .record-item { 
            background: white; 
            margin-bottom: 15px; 
            padding: 18px; 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border-left: 5px solid var(--primary-red);
            transition: 0.2s;
        }
        .record-item:hover { transform: translateX(3px); }
        
        .record-info { display: flex; justify-content: space-between; margin-bottom: 10px; color: #999; font-size: 0.8rem;}
        .record-name { font-weight: bold; color: #333; font-size: 1rem; display: flex; align-items: center; gap: 5px;}
        .record-reason { color: #555; font-size: 0.95rem; line-height: 1.6; }

        /* å½ˆçª—å„ªåŒ– */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; width: 85%; max-width: 320px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        textarea { 
            width: 100%; height: 100px; margin: 15px 0; padding: 15px; 
            border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; 
            font-size: 1rem; resize: none; font-family: inherit;
            background: #fafafa;
        }
        textarea:focus { outline: none; border-color: var(--primary-red); background: white; }
        
        .btn { 
            background: var(--primary-red); color: white; border: none; padding: 14px 0; width: 100%; 
            border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: bold; 
            transition: 0.2s; box-shadow: 0 4px 12px rgba(217, 48, 37, 0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(217, 48, 37, 0.4); }
        .btn:disabled { background: #ccc; box-shadow: none; transform: none; cursor: not-allowed; }

        /* ç™»å…¥é é¢ */
        #loginScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; box-sizing: border-box; background-image: radial-gradient(#e0e0e0 2px, transparent 2px); background-size: 20px 20px; }
        input[type="text"] { width: 100%; padding: 15px; margin: 20px 0; border: 2px solid #ddd; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; text-align: center; font-family: inherit;}
        input[type="text"]:focus { outline: none; border-color: var(--primary-red); }

        /* éŒ¯èª¤è¨Šæ¯ */
        .error-box { background: #ffeceb; color: var(--primary-red); padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.9rem; border: 1px solid #ffccc7; display: none;}
    </style>
</head>
<body>

<div class="app-container">
    <div id="loginScreen">
        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸƒğŸ’¨</div>
        <h1 style="font-size: 2rem; margin-bottom: 10px;">CL é›¢è·é›†é»è¶£</h1>
        <p style="color:#666; margin-bottom: 30px;">å¿ç„¡å¯å¿ï¼Œç„¡éœ€å†å¿</p>
        <input type="text" id="nicknameInput" placeholder="å–å€‹éŸ¿äº®çš„ä»£è™Ÿ (Ex: å…§æ¹–é‡‘åŸæ­¦)">
        <button class="btn" onclick="login()">ğŸš€ é€²å…¥ä¿®ç¾…å ´</button>
    </div>

    <header>
        <h1>CL é›¢è·é›†é»è¶£ ğŸ§—</h1>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('card', this)">ğŸ« æˆ‘çš„é›†é»</div>
        <div class="tab" onclick="switchTab('list', this)">ğŸ“£ å¤§å®¶çš„å¿ƒè²</div>
    </div>

    <div class="user-info">
        <span>Hi, <span id="displayNickname" style="font-weight:bold; color:var(--primary-red);">...</span></span>
        <a class="logout-link" onclick="logout()">ç™»å‡º</a>
    </div>

    <div id="cardView" class="card-view">
        <div class="loyalty-card">
            <div class="card-header">
                <span style="color:#888; font-size:0.9rem;">ç´¯ç©æ€¨æ°£å€¼</span>
                <span class="points-display"><span id="stampCount">0</span><span style="font-size:1rem; color:#aaa;"> / 12</span></span>
            </div>
            <div class="stamp-grid" id="grid"></div>
        </div>
        <p style="color:#999; font-size:0.85rem; text-align:center;">ğŸ’¡ é»æ“Šé–ƒçˆçš„æ ¼å­ä¾†è¨˜éŒ„ä½ çš„å´©æ½°ç¬é–“</p>
        
        <div id="errorMsg" class="error-box">
            âš ï¸ <b>è®€å–å¤±æ•—</b><br>
            è«‹ç¢ºèª Google Sheet å·¥ä½œè¡¨åç¨±æ˜¯å¦ç‚º <b>records</b>ï¼Œ<br>
            ä¸” Apps Script æ¬Šé™å·²è¨­ç‚ºã€Œä»»ä½•äººã€ã€‚
        </div>
    </div>

    <div id="listView" class="list-view">
        <div id="recordList" style="text-align: center; padding: 40px; color: #999;">
            <div style="font-size: 2rem; margin-bottom: 10px;">â³</div>
            è®€å–å¤§å®¶çš„å¿ƒè²ä¸­...
        </div>
    </div>
</div>

<div class="modal" id="reasonModal">
    <div class="modal-content">
        <h2 style="margin-top:0;">ğŸ’­ èŒç”Ÿé€€æ„...</h2>
        <p style="color:#666; font-size:0.95rem;">é€™æ¬¡æ˜¯å› ç‚ºä»€éº¼äº‹å‘¢ï¼Ÿ<br>(ç†ç”±æœƒåŒ¿åé¡¯ç¤ºåœ¨å…¬ä½ˆæ¬„)</p>
        <textarea id="reasonText" placeholder="Ex: éš”å£åŒäº‹è¬›é›»è©±å¤ªå¤§è²..."></textarea>
        <button id="confirmBtn" class="btn" onclick="submitReason()">ğŸ’¢ è“‹ä¸‹ç¢ºèªç« </button>
        <button style="background:transparent; color:#999; margin-top:15px; font-size:0.9rem; border:none; cursor:pointer;" onclick="closeModal()">ç®—äº†ï¼Œå†å¿å¿</button>
    </div>
</div>

<script>
    // ==========================================
    // ä½ çš„æ–°ç¶²å€ (å·²æ›´æ–°)
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyYNsTAehnOHJV3T3V3XaoqH0hPL6TN9oCkWuu1vNXWa2dqYasqQ67ZxfVvIP7H6jy2Zg/exec"; 

    let currentUser = "";
    let localStampCount = 0; 
    let userIP = "Unknown";

    const grid = document.getElementById('grid');
    const modal = document.getElementById('reasonModal');

    function init() {
        initGrid();
        
        // è‡ªå‹•ç™»å…¥
        const savedName = localStorage.getItem('cl_nickname');
        if(savedName) {
            currentUser = savedName;
            document.getElementById('displayNickname').innerText = currentUser;
            document.getElementById('loginScreen').style.display = 'none';
            fetchData();
        }

        // å·å·æŠ“ IP
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => { userIP = data.ip; })
            .catch(() => {});
    }

    function initGrid() {
        grid.innerHTML = '';
        for(let i=0; i<12; i++) {
            let slot = document.createElement('div');
            slot.className = 'stamp-slot';
            slot.dataset.idx = i;
            grid.appendChild(slot);
        }
    }

    function login() {
        const input = document.getElementById('nicknameInput').value.trim();
        if(!input) return alert("è«‹è¼¸å…¥ä¸€å€‹ä»£è™Ÿï¼");
        
        currentUser = input;
        localStorage.setItem('cl_nickname', currentUser);
        
        document.getElementById('displayNickname').innerText = currentUser;
        document.getElementById('loginScreen').style.display = 'none';
        
        fetchData();
    }

    function logout() {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
            localStorage.removeItem('cl_nickname');
            location.reload(); 
        }
    }

    function switchTab(viewName, tabElement) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabElement.classList.add('active');

        if(viewName === 'card') {
            document.getElementById('cardView').style.display = 'flex';
            document.getElementById('listView').style.display = 'none';
        } else {
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            // åˆ‡æ›åˆ°åˆ—è¡¨æ™‚ï¼Œå¼·åˆ¶åˆ·æ–°è³‡æ–™
            fetchData();
        }
    }

    function openModal() {
        modal.style.display = 'flex';
        setTimeout(() => document.getElementById('reasonText').focus(), 100);
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    function submitReason() {
        const reason = document.getElementById('reasonText').value;
        if(!reason) return alert("è«‹å¯«ä¸‹åŸå› ï¼Œå®£æ´©ä¸€ä¸‹ï¼");

        const btn = document.getElementById('confirmBtn');
        btn.innerText = "è“‹ç« ä¸­...";
        btn.disabled = true;

        // å‰ç«¯å…ˆæ›´æ–° (æ¨‚è§€æ›´æ–°)
        localStampCount++; 
        updateGrid(localStampCount); 

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                nickname: currentUser, 
                reason: reason,
                ip: userIP 
            }),
            mode: 'no-cors' 
        }).then(() => {
            closeModal();
            document.getElementById('reasonText').value = '';
            btn.innerText = "ğŸ’¢ è“‹ä¸‹ç¢ºèªç« ";
            btn.disabled = false;
            // å»¶é²åŒæ­¥
            setTimeout(fetchData, 2000); 
        }).catch(err => {
            alert("ç¶²è·¯ä¸ç©©ï¼Œä½†ç« å…ˆå¹«ä½ è“‹å¥½äº†ï¼");
            btn.disabled = false;
        });
    }

    function fetchData() {
        document.getElementById('errorMsg').style.display = 'none';
        
        // åŠ ä¸Šæ™‚é–“åƒæ•¸é˜²å¿«å–
        const antiCacheURL = SCRIPT_URL + "?t=" + new Date().getTime();

        fetch(antiCacheURL)
        .then(res => res.json())
        .then(data => {
            // 1. è™•ç†å€‹äººé›†é»
            const myRecords = data.filter(d => d.nickname.trim() === currentUser.trim());
            const serverCount = myRecords.length;

            if (serverCount > localStampCount) {
                localStampCount = serverCount;
            }
            updateGrid(localStampCount);

            // 2. è™•ç†åˆ—è¡¨
            const listDiv = document.getElementById('recordList');
            listDiv.innerHTML = '';
            
            if (data.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ç›®å‰ä¸€ç‰‡ç¥¥å’Œ ğŸ•Šï¸</div>';
            } else {
                data.forEach(item => {
                    let div = document.createElement('div');
                    div.className = 'record-item';
                    
                    let dateObj = new Date(item.time);
                    let dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${dateObj.getHours()}:${(dateObj.getMinutes()<10?'0':'')+dateObj.getMinutes()}`;

                    div.innerHTML = `
                        <div class="record-info">
                            <span class="record-name">ğŸ‘¤ ${item.nickname}</span>
                            <span>${dateStr}</span>
                        </div>
                        <div class="record-reason">${item.reason}</div>
                    `;
                    listDiv.appendChild(div);
                });
            }
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('recordList').innerHTML = '<div style="text-align:center; color:#e74c3c;">è®€å–å¤±æ•— ğŸ˜±</div>';
        });
    }

    function updateGrid(count) {
        document.getElementById('stampCount').innerText = count;
        const slots = document.querySelectorAll('.stamp-slot');
        
        slots.forEach((slot, index) => {
            // é‡ç½®ç‹€æ…‹
            slot.className = 'stamp-slot'; 
            slot.onclick = null;

            if(index < count) {
                // å·²è“‹ç« 
                slot.classList.add('stamped');
            } else if (index === count) {
                // ä¸‹ä¸€å€‹è¦è“‹çš„
                slot.classList.add('next-up');
                slot.onclick = openModal;
            } else {
                // æœªä¾†é‚„ä¸èƒ½è“‹çš„
                slot.onclick = () => alert("åˆ¥æ€¥ï¼Œé£¯è¦ä¸€å£ä¸€å£åƒï¼Œç« è¦ä¸€å€‹ä¸€å€‹è“‹ï¼ğŸ¥£");
            }
        });
    }

    init();

    window.onclick = function(event) {
        if (event.target == modal) closeModal();
    }
</script>

</body>
</html>
